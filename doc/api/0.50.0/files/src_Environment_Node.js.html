<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/Environment/Node.js - TinCanJS</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://cdn4.tincanapi.com/wp-content/themes/tincanapi/images/logo.png" title="TinCanJS"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.50.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/TinCan.html">TinCan</a></li>
            
                <li><a href="../classes/TinCan.About.html">TinCan.About</a></li>
            
                <li><a href="../classes/TinCan.Activity.html">TinCan.Activity</a></li>
            
                <li><a href="../classes/TinCan.ActivityDefinition.html">TinCan.ActivityDefinition</a></li>
            
                <li><a href="../classes/TinCan.ActivityProfile.html">TinCan.ActivityProfile</a></li>
            
                <li><a href="../classes/TinCan.Agent.html">TinCan.Agent</a></li>
            
                <li><a href="../classes/TinCan.AgentAccount.html">TinCan.AgentAccount</a></li>
            
                <li><a href="../classes/TinCan.AgentProfile.html">TinCan.AgentProfile</a></li>
            
                <li><a href="../classes/TinCan.Attachment.html">TinCan.Attachment</a></li>
            
                <li><a href="../classes/TinCan.Context.html">TinCan.Context</a></li>
            
                <li><a href="../classes/TinCan.ContextActivities.html">TinCan.ContextActivities</a></li>
            
                <li><a href="../classes/TinCan.Group.html">TinCan.Group</a></li>
            
                <li><a href="../classes/TinCan.InteractionComponent.html">TinCan.InteractionComponent</a></li>
            
                <li><a href="../classes/TinCan.LRS.html">TinCan.LRS</a></li>
            
                <li><a href="../classes/TinCan.Result.html">TinCan.Result</a></li>
            
                <li><a href="../classes/TinCan.Score.html">TinCan.Score</a></li>
            
                <li><a href="../classes/TinCan.State.html">TinCan.State</a></li>
            
                <li><a href="../classes/TinCan.Statement.html">TinCan.Statement</a></li>
            
                <li><a href="../classes/TinCan.StatementRef.html">TinCan.StatementRef</a></li>
            
                <li><a href="../classes/TinCan.StatementsResult.html">TinCan.StatementsResult</a></li>
            
                <li><a href="../classes/TinCan.SubStatement.html">TinCan.SubStatement</a></li>
            
                <li><a href="../classes/TinCan.Utils.html">TinCan.Utils</a></li>
            
                <li><a href="../classes/TinCan.Verb.html">TinCan.Verb</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/TinCan.html">TinCan</a></li>
            
                <li><a href="../modules/TinCan.About.html">TinCan.About</a></li>
            
                <li><a href="../modules/TinCan.Activity.html">TinCan.Activity</a></li>
            
                <li><a href="../modules/TinCan.ActivityDefinition.html">TinCan.ActivityDefinition</a></li>
            
                <li><a href="../modules/TinCan.ActivityProfile.html">TinCan.ActivityProfile</a></li>
            
                <li><a href="../modules/TinCan.Agent.html">TinCan.Agent</a></li>
            
                <li><a href="../modules/TinCan.AgentAccount.html">TinCan.AgentAccount</a></li>
            
                <li><a href="../modules/TinCan.AgentProfile.html">TinCan.AgentProfile</a></li>
            
                <li><a href="../modules/TinCan.Attachment.html">TinCan.Attachment</a></li>
            
                <li><a href="../modules/TinCan.Context.html">TinCan.Context</a></li>
            
                <li><a href="../modules/TinCan.ContextActivities.html">TinCan.ContextActivities</a></li>
            
                <li><a href="../modules/TinCan.Environment.Browser.html">TinCan.Environment.Browser</a></li>
            
                <li><a href="../modules/TinCan.Environment.Node.html">TinCan.Environment.Node</a></li>
            
                <li><a href="../modules/TinCan.Group.html">TinCan.Group</a></li>
            
                <li><a href="../modules/TinCan.InteractionComponent.html">TinCan.InteractionComponent</a></li>
            
                <li><a href="../modules/TinCan.LRS.html">TinCan.LRS</a></li>
            
                <li><a href="../modules/TinCan.Result.html">TinCan.Result</a></li>
            
                <li><a href="../modules/TinCan.Score.html">TinCan.Score</a></li>
            
                <li><a href="../modules/TinCan.State.html">TinCan.State</a></li>
            
                <li><a href="../modules/TinCan.Statement.html">TinCan.Statement</a></li>
            
                <li><a href="../modules/TinCan.StatementRef.html">TinCan.StatementRef</a></li>
            
                <li><a href="../modules/TinCan.StatementsResult.html">TinCan.StatementsResult</a></li>
            
                <li><a href="../modules/TinCan.SubStatement.html">TinCan.SubStatement</a></li>
            
                <li><a href="../modules/TinCan.Utils.html">TinCan.Utils</a></li>
            
                <li><a href="../modules/TinCan.Verb.html">TinCan.Verb</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/Environment/Node.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
    Copyright 2012-2013 Rustici Software

    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
*/

/**
TinCan client library

@module TinCan
@submodule TinCan.Environment.Node
**/
(function () {
    /* globals require,Buffer,ArrayBuffer,Uint8Array */
    &quot;use strict&quot;;
    var LOG_SRC = &quot;Environment.Node&quot;,
        log = TinCan.prototype.log,
        querystring = require(&quot;querystring&quot;),
        XMLHttpRequest = require(&quot;xhr2&quot;),
        requestComplete,
        __createJSONSegment,
        __createAttachmentSegment;

    requestComplete = function (xhr, cfg) {
        log(&quot;requestComplete - xhr.status: &quot; + xhr.status, LOG_SRC);
        log(&quot;requestComplete - xhr.responseText: &quot; + xhr.responseText, LOG_SRC);
        var requestCompleteResult,
            httpStatus = xhr.status,
            notFoundOk = (cfg.ignore404 &amp;&amp; httpStatus === 404);

        if ((httpStatus &gt;= 200 &amp;&amp; httpStatus &lt; 400) || notFoundOk) {
            if (cfg.callback) {
                cfg.callback(null, xhr);
                return;
            }

            requestCompleteResult = {
                err: null,
                xhr: xhr
            };
            return requestCompleteResult;
        }

        requestCompleteResult = {
            err: httpStatus,
            xhr: xhr
        };
        if (httpStatus === 0) {
            log(&quot;[warning] There was a problem communicating with the Learning Record Store. Aborted, offline, or invalid CORS endpoint (&quot; + httpStatus + &quot;)&quot;, LOG_SRC);
        }
        else {
            log(&quot;[warning] There was a problem communicating with the Learning Record Store. (&quot; + httpStatus + &quot; | &quot; + xhr.responseText+ &quot;)&quot;, LOG_SRC);
        }
        if (cfg.callback) {
            cfg.callback(httpStatus, xhr);
        }
        return requestCompleteResult;
    };

    //
    // Override LRS&#x27; init method to set up our request handling
    // capabilities, basically empty implementation here so that
    // we don&#x27;t get a no-env loaded message
    //
    TinCan.LRS.prototype._initByEnvironment = function () {};

    //
    // use XMLHttpRequest module instead of standard Node.js http/https
    // modules since we have to support both, and because the callbacks
    // provided via the methods calling _makeRequest expect the xhr to
    // have a certain interface, that interface happens to be the browser
    // version of XHR since that&#x27;s where it started, so rather than
    // changing them to use a different wrapped request/response object
    // set just use a wrapped version of the node objects which is what
    // XMLHttpRequest module provides
    //
    TinCan.LRS.prototype._makeRequest = function (fullUrl, headers, cfg) {
        log(&quot;_makeRequest using http/https&quot;, LOG_SRC);
        var xhr,
            url = fullUrl,
            async = typeof cfg.callback !== &quot;undefined&quot;,
            prop
        ;
        if (typeof cfg.params !== &quot;undefined&quot; &amp;&amp; Object.keys(cfg.params).length &gt; 0) {
            url += &quot;?&quot; + querystring.stringify(cfg.params);
        }

        xhr = new XMLHttpRequest();
        xhr.open(cfg.method, url, async);

        if (cfg.expectMultipart) {
            xhr.responseType = &quot;arraybuffer&quot;;
        }

        for (prop in headers) {
            if (headers.hasOwnProperty(prop)) {
                xhr.setRequestHeader(prop, headers[prop]);
            }
        }

        if (typeof cfg.data !== &quot;undefined&quot;) {
            cfg.data += &quot;&quot;;
        }

        if (async) {
            xhr.onreadystatechange = function () {
                log(&quot;xhr.onreadystatechange - xhr.readyState: &quot; + xhr.readyState, LOG_SRC);
                if (xhr.readyState === 4) {
                    requestComplete(xhr, cfg);
                }
            };
        }

        xhr.send(cfg.data);

        if (async) {
            return xhr;
        }

        return requestComplete(xhr, cfg);
    };

    //
    // Synchronos xhr handling is unsupported in node
    //
    TinCan.LRS.syncEnabled = false;

    TinCan.LRS.prototype._getMultipartRequestData = function (boundary, jsonContent, requestAttachments) {
        var parts = [],
            i;

        parts.push(
            __createJSONSegment(
                boundary,
                jsonContent
            )
        );
        for (i = 0; i &lt; requestAttachments.length; i += 1) {
            if (requestAttachments[i].content !== null) {
                parts.push(
                    __createAttachmentSegment(
                        boundary,
                        requestAttachments[i].content,
                        requestAttachments[i].sha2,
                        requestAttachments[i].contentType
                    )
                );
            }
        }
        if (typeof Buffer.from === &quot;undefined&quot;) {
            parts.push( new Buffer(&quot;\r\n--&quot; + boundary + &quot;--\r\n&quot;) );
        }
        else {
            parts.push( Buffer.from(&quot;\r\n--&quot; + boundary + &quot;--\r\n&quot;) );
        }

        return Buffer.concat(parts);
    };

    __createJSONSegment = function (boundary, jsonContent) {
        var content = [
                &quot;--&quot; + boundary,
                &quot;Content-Type: application/json&quot;,
                &quot;&quot;,
                JSON.stringify(jsonContent)
            ].join(&quot;\r\n&quot;);

        content += &quot;\r\n&quot;;

        if (typeof Buffer.from === &quot;undefined&quot;) {
            return new Buffer(content);
        }
        return Buffer.from(content);
    };

    __createAttachmentSegment = function (boundary, content, sha2, contentType) {
        var bufferParts = [],
            header = [
                &quot;--&quot; + boundary,
                &quot;Content-Type: &quot; + contentType,
                &quot;Content-Transfer-Encoding: binary&quot;,
                &quot;X-Experience-API-Hash: &quot; + sha2
            ].join(&quot;\r\n&quot;);

        header += &quot;\r\n\r\n&quot;;

        if (typeof Buffer.from === &quot;undefined&quot;) {
            bufferParts.push( new Buffer(header) );
            bufferParts.push( new Buffer(content) );
        }
        else {
            bufferParts.push(Buffer.from(header));
            bufferParts.push(Buffer.from(content));
        }

        return Buffer.concat(bufferParts);
    };

    TinCan.Utils.stringToArrayBuffer = function (content, encoding) {
        var b,
            ab,
            view,
            i;

        if (! encoding) {
            encoding = TinCan.Utils.defaultEncoding;
        }

        if (typeof Buffer.from === &quot;undefined&quot;) {
            // for Node.js prior to v4.x
            b = new Buffer(content, encoding);

            ab = new ArrayBuffer(b.length);
            view = new Uint8Array(ab);
            for (i = 0; i &lt; b.length; i += 1) {
                view[i] = b[i];
            }

            return ab;
        }

        b = Buffer.from(content, encoding);
        ab = b.buffer;

        //
        // this .slice is required because of the internals of how Buffer is
        // implemented, it uses a shared ArrayBuffer underneath for small buffers
        // see http://stackoverflow.com/a/31394257/1464957
        //
        return ab.slice(b.byteOffset, b.byteOffset + b.byteLength);
    };

    TinCan.Utils.stringFromArrayBuffer = function (content, encoding) {
        var b,
            view,
            i;

        if (! encoding) {
            encoding = TinCan.Utils.defaultEncoding;
        }

        if (typeof Buffer.from === &quot;undefined&quot;) {
            // for Node.js prior to v4.x
            b = new Buffer(content.byteLength);

            view = new Uint8Array(content);
            for (i = 0; i &lt; b.length; i += 1) {
                b[i] = view[i];
            }
        }
        else {
            b = Buffer.from(content);
        }

        return b.toString(encoding);
    };
}());

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
