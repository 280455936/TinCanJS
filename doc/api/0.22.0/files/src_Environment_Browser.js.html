<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/Environment/Browser.js - TinCanJS</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://cdn4.tincanapi.com/wp-content/themes/tincanapi/images/logo.png" title="TinCanJS"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.22.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/TinCan.html">TinCan</a></li>
            
                <li><a href="../classes/TinCan.Activity.html">TinCan.Activity</a></li>
            
                <li><a href="../classes/TinCan.ActivityDefinition.html">TinCan.ActivityDefinition</a></li>
            
                <li><a href="../classes/TinCan.ActivityProfile.html">TinCan.ActivityProfile</a></li>
            
                <li><a href="../classes/TinCan.Agent.html">TinCan.Agent</a></li>
            
                <li><a href="../classes/TinCan.AgentAccount.html">TinCan.AgentAccount</a></li>
            
                <li><a href="../classes/TinCan.AgentProfile.html">TinCan.AgentProfile</a></li>
            
                <li><a href="../classes/TinCan.Context.html">TinCan.Context</a></li>
            
                <li><a href="../classes/TinCan.ContextActivities.html">TinCan.ContextActivities</a></li>
            
                <li><a href="../classes/TinCan.Group.html">TinCan.Group</a></li>
            
                <li><a href="../classes/TinCan.InteractionComponent.html">TinCan.InteractionComponent</a></li>
            
                <li><a href="../classes/TinCan.LRS.html">TinCan.LRS</a></li>
            
                <li><a href="../classes/TinCan.Result.html">TinCan.Result</a></li>
            
                <li><a href="../classes/TinCan.Score.html">TinCan.Score</a></li>
            
                <li><a href="../classes/TinCan.State.html">TinCan.State</a></li>
            
                <li><a href="../classes/TinCan.Statement.html">TinCan.Statement</a></li>
            
                <li><a href="../classes/TinCan.StatementRef.html">TinCan.StatementRef</a></li>
            
                <li><a href="../classes/TinCan.StatementsResult.html">TinCan.StatementsResult</a></li>
            
                <li><a href="../classes/TinCan.SubStatement.html">TinCan.SubStatement</a></li>
            
                <li><a href="../classes/TinCan.Utils.html">TinCan.Utils</a></li>
            
                <li><a href="../classes/TinCan.Verb.html">TinCan.Verb</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/TinCan.html">TinCan</a></li>
            
                <li><a href="../modules/TinCan.Activity.html">TinCan.Activity</a></li>
            
                <li><a href="../modules/TinCan.ActivityDefinition.html">TinCan.ActivityDefinition</a></li>
            
                <li><a href="../modules/TinCan.ActivityProfile.html">TinCan.ActivityProfile</a></li>
            
                <li><a href="../modules/TinCan.Agent.html">TinCan.Agent</a></li>
            
                <li><a href="../modules/TinCan.AgentAccount.html">TinCan.AgentAccount</a></li>
            
                <li><a href="../modules/TinCan.AgentProfile.html">TinCan.AgentProfile</a></li>
            
                <li><a href="../modules/TinCan.Context.html">TinCan.Context</a></li>
            
                <li><a href="../modules/TinCan.ContextActivities.html">TinCan.ContextActivities</a></li>
            
                <li><a href="../modules/TinCan.Environment.Browser.html">TinCan.Environment.Browser</a></li>
            
                <li><a href="../modules/TinCan.Environment.Node.html">TinCan.Environment.Node</a></li>
            
                <li><a href="../modules/TinCan.Group.html">TinCan.Group</a></li>
            
                <li><a href="../modules/TinCan.InteractionComponent.html">TinCan.InteractionComponent</a></li>
            
                <li><a href="../modules/TinCan.LRS.html">TinCan.LRS</a></li>
            
                <li><a href="../modules/TinCan.Result.html">TinCan.Result</a></li>
            
                <li><a href="../modules/TinCan.Score.html">TinCan.Score</a></li>
            
                <li><a href="../modules/TinCan.State.html">TinCan.State</a></li>
            
                <li><a href="../modules/TinCan.Statement.html">TinCan.Statement</a></li>
            
                <li><a href="../modules/TinCan.StatementRef.html">TinCan.StatementRef</a></li>
            
                <li><a href="../modules/TinCan.StatementsResult.html">TinCan.StatementsResult</a></li>
            
                <li><a href="../modules/TinCan.SubStatement.html">TinCan.SubStatement</a></li>
            
                <li><a href="../modules/TinCan.Utils.html">TinCan.Utils</a></li>
            
                <li><a href="../modules/TinCan.Verb.html">TinCan.Verb</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/Environment/Browser.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
    Copyright 2012-2013 Rustici Software

    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
*/

/**
TinCan client library

@module TinCan
@submodule TinCan.Environment.Browser
**/
(function () {
    &quot;use strict&quot;;
    var LOG_SRC = &quot;Environment.Browser&quot;,
        nativeRequest,
        xdrRequest,
        requestComplete,
        __delay,
        env = {},
        log = TinCan.prototype.log;

    if (typeof window === &quot;undefined&quot;) {
        log(&quot;&#x27;window&#x27; not defined&quot;, LOG_SRC);
        return;
    }

    /* Shims for browsers not supporting our needs, mainly IE */

    //
    // Make JSON safe for IE6
    // https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/JSON#Browser_compatibility
    //
    if (!window.JSON) {
        window.JSON = {
            parse: function (sJSON) {
                /*jslint evil: true */
                return eval(&quot;(&quot; + sJSON + &quot;)&quot;);
            },
            stringify: function (vContent) {
                var sOutput = &quot;&quot;,
                    nId,
                    sProp
                ;
                if (vContent instanceof Object) {
                    if (vContent.constructor === Array) {
                        for (nId = 0; nId &lt; vContent.length; nId += 1) {
                            sOutput += this.stringify(vContent[nId]) + &quot;,&quot;;
                        }
                        return &quot;[&quot; + sOutput.substr(0, sOutput.length - 1) + &quot;]&quot;;
                    }
                    if (vContent.toString !== Object.prototype.toString) { return &quot;\&quot;&quot; + vContent.toString().replace(/&quot;/g, &quot;\\$&amp;&quot;) + &quot;\&quot;&quot;; }
                    for (sProp in vContent) {
                        if (vContent.hasOwnProperty(sProp)) {
                            sOutput += &quot;\&quot;&quot; + sProp.replace(/&quot;/g, &quot;\\$&amp;&quot;) + &quot;\&quot;:&quot; + this.stringify(vContent[sProp]) + &quot;,&quot;;
                        }
                    }
                    return &quot;{&quot; + sOutput.substr(0, sOutput.length - 1) + &quot;}&quot;;
                }
                return typeof vContent === &quot;string&quot; ? &quot;\&quot;&quot; + vContent.replace(/&quot;/g, &quot;\\$&amp;&quot;) + &quot;\&quot;&quot; : String(vContent);
            }
        };
    }

    //
    // Make Date.now safe for IE &lt; 9
    // https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Date/now
    //
    if (!Date.now) {
        Date.now = function () {
            return +(new Date ());
        };
    }

    /* Detect CORS and XDR support */
    env.hasCORS = false;
    env.useXDR = false;

    if (typeof XMLHttpRequest !== &quot;undefined&quot; &amp;&amp; typeof (new XMLHttpRequest()).withCredentials !== &quot;undefined&quot;) {
        env.hasCORS = true;
    }
    else if (typeof XDomainRequest !== &quot;undefined&quot;) {
        env.hasCORS = true;
        env.useXDR = true;
    }

    // TODO: should we have our own internal &quot;Request&quot; object
    //       that replaces the need for &quot;control&quot;?

    //
    // Setup request callback
    //
    requestComplete = function (xhr, cfg, control) {
        log(&quot;requestComplete: &quot; + control.finished + &quot;, xhr.status: &quot; + xhr.status, LOG_SRC);
        var requestCompleteResult,
            notFoundOk,
            httpStatus;

        //
        // XDomainRequest doesn&#x27;t give us a way to get the status,
        // so allow passing in a forged one
        //
        if (typeof xhr.status === &quot;undefined&quot;) {
            httpStatus = control.fakeStatus;
        }
        else {
            //
            // older versions of IE don&#x27;t properly handle 204 status codes
            // so correct when receiving a 1223 to be 204 locally
            // http://stackoverflow.com/questions/10046972/msie-returns-status-code-of-1223-for-ajax-request
            //
            httpStatus = (xhr.status === 1223) ? 204 : xhr.status;
        }

        if (! control.finished) {
            // may be in sync or async mode, using XMLHttpRequest or IE XDomainRequest, onreadystatechange or
            // onload or both might fire depending upon browser, just covering all bases with event hooks and
            // using &#x27;finished&#x27; flag to avoid triggering events multiple times
            control.finished = true;

            notFoundOk = (cfg.ignore404 &amp;&amp; httpStatus === 404);
            if ((httpStatus &gt;= 200 &amp;&amp; httpStatus &lt; 400) || notFoundOk) {
                if (cfg.callback) {
                    cfg.callback(null, xhr);
                }
                else {
                    requestCompleteResult = {
                        err: null,
                        xhr: xhr
                    };
                    return requestCompleteResult;
                }
            }
            else {
                requestCompleteResult = {
                    err: httpStatus,
                    xhr: xhr
                };
                if (httpStatus === 0) {
                    log(&quot;[warning] There was a problem communicating with the Learning Record Store. Aborted, offline, or invalid CORS endpoint (&quot; + httpStatus + &quot;)&quot;, LOG_SRC);
                }
                else {
                    log(&quot;[warning] There was a problem communicating with the Learning Record Store. (&quot; + httpStatus + &quot; | &quot; + xhr.responseText+ &quot;)&quot;, LOG_SRC);
                }
                if (cfg.callback) {
                    cfg.callback(httpStatus, xhr);
                }
                return requestCompleteResult;
            }
        }
        else {
            return requestCompleteResult;
        }
    };

    //
    // one of the two of these is stuffed into the LRS&#x27; instance
    // as ._makeRequest
    //
    nativeRequest = function (fullUrl, headers, cfg) {
        /*global ActiveXObject*/
        log(&quot;sendRequest using XMLHttpRequest&quot;, LOG_SRC);
        var self = this,
            xhr,
            prop,
            pairs = [],
            data,
            control = {
                finished: false,
                fakeStatus: null
            },
            async = typeof cfg.callback !== &quot;undefined&quot;
        ;
        log(&quot;sendRequest using XMLHttpRequest - async: &quot; + async, LOG_SRC);

        for (prop in cfg.params) {
            if (cfg.params.hasOwnProperty(prop)) {
                pairs.push(prop + &quot;=&quot; + encodeURIComponent(cfg.params[prop]));
            }
        }
        if (pairs.length &gt; 0) {
            fullUrl += &quot;?&quot; + pairs.join(&quot;&amp;&quot;);
        }

        if (typeof XMLHttpRequest !== &quot;undefined&quot;) {
            xhr = new XMLHttpRequest();
        }
        else {
            //
            // IE6 implements XMLHttpRequest through ActiveX control
            // http://blogs.msdn.com/b/ie/archive/2006/01/23/516393.aspx
            //
            xhr = new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);
        }

        xhr.open(cfg.method, fullUrl, async);
        for (prop in headers) {
            if (headers.hasOwnProperty(prop)) {
                xhr.setRequestHeader(prop, headers[prop]);
            }
        }

        if (typeof cfg.data !== &quot;undefined&quot;) {
            cfg.data += &quot;&quot;;
        }
        data = cfg.data;

        if (async) {
            xhr.onreadystatechange = function () {
                log(&quot;xhr.onreadystatechange - xhr.readyState: &quot; + xhr.readyState, LOG_SRC);
                if (xhr.readyState === 4) {
                    requestComplete.call(self, xhr, cfg, control);
                }
            };
        }

        //
        // research indicates that IE is known to just throw exceptions
        // on .send and it seems everyone pretty much just ignores them
        // including jQuery (https://github.com/jquery/jquery/blob/1.10.2/src/ajax.js#L549
        // https://github.com/jquery/jquery/blob/1.10.2/src/ajax/xhr.js#L97)
        //
        try {
            xhr.send(data);
        }
        catch (ex) {
            log(&quot;sendRequest caught send exception: &quot; + ex, LOG_SRC);
        }

        if (async) {
            //
            // for async requests give them the XHR object directly
            // as the return value, the actual stuff they should be
            // caring about is params to the callback, for sync
            // requests they got the return value above
            //
            return xhr;
        }

        return requestComplete.call(this, xhr, cfg, control);
    };
    xdrRequest = function (fullUrl, headers, cfg) {
        log(&quot;sendRequest using XDomainRequest&quot;, LOG_SRC);
        var self = this,
            xhr,
            pairs = [],
            data,
            prop,
            until,
            control = {
                finished: false,
                fakeStatus: null
            };

        // method has to go on querystring, and nothing else,
        // and the actual method is then always POST
        fullUrl += &quot;?method=&quot; + cfg.method;

        // params end up in the body
        for (prop in cfg.params) {
            if (cfg.params.hasOwnProperty(prop)) {
                pairs.push(prop + &quot;=&quot; + encodeURIComponent(cfg.params[prop]));
            }
        }

        // headers go into form data
        for (prop in headers) {
            if (headers.hasOwnProperty(prop)) {
                pairs.push(prop + &quot;=&quot; + encodeURIComponent(headers[prop]));
            }
        }

        // the original data is repackaged as &quot;content&quot; form var
        if (cfg.data !== null) {
            pairs.push(&quot;content=&quot; + encodeURIComponent(cfg.data));
        }

        data = pairs.join(&quot;&amp;&quot;);

        xhr = new XDomainRequest ();
        xhr.open(&quot;POST&quot;, fullUrl);

        if (! cfg.callback) {
            xhr.onload = function () {
                control.fakeStatus = 200;
            };
            xhr.onerror = function () {
                control.fakeStatus = 400;
            };
            xhr.ontimeout = function () {
                control.fakeStatus = 0;
            };
        }
        else {
            xhr.onload = function () {
                control.fakeStatus = 200;
                requestComplete.call(self, xhr, cfg, control);
            };
            xhr.onerror = function () {
                control.fakeStatus = 400;
                requestComplete.call(self, xhr, cfg, control);
            };
            xhr.ontimeout = function () {
                control.fakeStatus = 0;
                requestComplete.call(self, xhr, cfg, control);
            };
        }

        // IE likes to randomly abort requests when some handlers
        // aren&#x27;t defined, so define them with no-ops, see:
        //
        // http://cypressnorth.com/programming/internet-explorer-aborting-ajax-requests-fixed/
        // http://social.msdn.microsoft.com/Forums/ie/en-US/30ef3add-767c-4436-b8a9-f1ca19b4812e/ie9-rtm-xdomainrequest-issued-requests-may-abort-if-all-event-handlers-not-specified
        //
        xhr.onprogress = function () {};
        xhr.timeout = 0;

        //
        // research indicates that IE is known to just throw exceptions
        // on .send and it seems everyone pretty much just ignores them
        // including jQuery (https://github.com/jquery/jquery/blob/1.10.2/src/ajax.js#L549
        // https://github.com/jquery/jquery/blob/1.10.2/src/ajax/xhr.js#L97)
        //
        try {
            xhr.send(data);
        }
        catch (ex) {
            log(&quot;sendRequest caught send exception: &quot; + ex, LOG_SRC);
        }

        if (! cfg.callback) {
            // synchronous call in IE, with no synchronous mode available
            until = 10000 + Date.now();
            log(&quot;sendRequest - until: &quot; + until + &quot;, finished: &quot; + control.finished, LOG_SRC);

            while (Date.now() &lt; until &amp;&amp; control.fakeStatus === null) {
                //log(&quot;calling __delay&quot;, LOG_SRC);
                __delay();
            }
            return requestComplete.call(self, xhr, cfg, control);
        }

        //
        // for async requests give them the XHR object directly
        // as the return value, the actual stuff they should be
        // caring about is params to the callback, for sync
        // requests they got the return value above
        //
        return xhr;
    };

    //
    // Override LRS&#x27; init method to set up our request handling
    // capabilities
    //
    TinCan.LRS.prototype._initByEnvironment = function (cfg) {
        /*jslint regexp: true */
        log(&quot;_initByEnvironment&quot;, LOG_SRC);
        var urlParts,
            schemeMatches,
            locationPort,
            isXD
        ;

        cfg = cfg || {};

        //
        // default to native request mode
        //
        this._makeRequest = nativeRequest;

        urlParts = this.endpoint.toLowerCase().match(/([A-Za-z]+:)\/\/([^:\/]+):?(\d+)?(\/.*)?$/);
        if (urlParts === null) {
            log(&quot;[error] LRS invalid: failed to divide URL parts&quot;, LOG_SRC);
            throw {
                code: 4,
                mesg: &quot;LRS invalid: failed to divide URL parts&quot;
            };
        }

        //
        // determine whether this is a cross domain request,
        // whether our browser has CORS support at all, and then
        // if it does then if we are in IE with XDR only check that
        // the schemes match to see if we should be able to talk to
        // the LRS
        //
        locationPort = location.port;
        schemeMatches = location.protocol.toLowerCase() === urlParts[1];

        //
        // normalize the location.port cause it appears to be &quot;&quot; when 80/443
        // but our endpoint may have provided it
        //
        if (locationPort === &quot;&quot;) {
            locationPort = (location.protocol.toLowerCase() === &quot;http:&quot; ? &quot;80&quot; : (location.protocol.toLowerCase() === &quot;https:&quot; ? &quot;443&quot; : &quot;&quot;));
        }

        isXD = (
            // is same scheme?
            ! schemeMatches

            // is same host?
            || location.hostname.toLowerCase() !== urlParts[2]

            // is same port?
            || locationPort !== (
                (urlParts[3] !== null &amp;&amp; typeof urlParts[3] !== &quot;undefined&quot; &amp;&amp; urlParts[3] !== &quot;&quot;) ? urlParts[3] : (urlParts[1] === &quot;http:&quot; ? &quot;80&quot; : (urlParts[1] === &quot;https:&quot; ? &quot;443&quot; : &quot;&quot;))
            )
        );
        if (isXD) {
            if (env.hasCORS) {
                if (env.useXDR &amp;&amp; schemeMatches) {
                    this._makeRequest = xdrRequest;
                }
                else if (env.useXDR &amp;&amp; ! schemeMatches) {
                    if (cfg.allowFail) {
                        log(&quot;[warning] LRS invalid: cross domain request for differing scheme in IE with XDR (allowed to fail)&quot;, LOG_SRC);
                    }
                    else {
                        log(&quot;[error] LRS invalid: cross domain request for differing scheme in IE with XDR&quot;, LOG_SRC);
                        throw {
                            code: 2,
                            mesg: &quot;LRS invalid: cross domain request for differing scheme in IE with XDR&quot;
                        };
                    }
                }
            }
            else {
                if (cfg.allowFail) {
                    log(&quot;[warning] LRS invalid: cross domain requests not supported in this browser (allowed to fail)&quot;, LOG_SRC);
                }
                else {
                    log(&quot;[error] LRS invalid: cross domain requests not supported in this browser&quot;, LOG_SRC);
                    throw {
                        code: 1,
                        mesg: &quot;LRS invalid: cross domain requests not supported in this browser&quot;
                    };
                }
            }
        }
    };

    /**
    Non-environment safe method used to create a delay to give impression
    of synchronous response (for IE, shocker)

    @method __delay
    @private
    */
    __delay = function () {
        //
        // use a synchronous request to the current location to allow the browser
        // to yield to the asynchronous request&#x27;s events but still block in the
        // outer loop to make it seem synchronous to the end user
        //
        // removing this made the while loop too tight to allow the asynchronous
        // events through to get handled so that the response was correctly handled
        //
        var xhr = new XMLHttpRequest (),
            url = window.location + &quot;?forcenocache=&quot; + TinCan.Utils.getUUID()
        ;
        xhr.open(&quot;GET&quot;, url, false);
        xhr.send(null);
    };
}());

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
